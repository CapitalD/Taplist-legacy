<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Tap List json Admin</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
	<link href="css/taplist_admin.css" rel="stylesheet" tyep="text/css">
    </head>

    <body>

        <div id="tap_sheet" class="container-fluid">
            <form role="form" id="tap_admin">
            	<div class="row" id="tap_row"></div>
        		<button type="button" name="create_json_button" id="create_json_button" class="btn btn-primary" data-toggle="modal" data-target="#json_output_modal">Create JSON</button>
				<input type="hidden" name="last_updated">
        	</form>
        </div>

		<!-- Output Modal -->
		<div class="modal fade" id="json_output_modal" tabindex="-1" role="dialog" aria-labelledby="JSON Output" aria-hidden="true">
		  <div class="modal-dialog">
		    <div class="modal-content">
		      <div class="modal-header">
		        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
		        <h4 class="modal-title" id="myModalLabel">Taplist JSON</h4>
		      </div>
		      <div class="modal-body">
		      	<code id="json_output"></code>
		      </div>
		    </div>
		  </div>
		</div>		

        <script src="http://code.jquery.com/jquery.js"></script>
        <script src="bootstrap/js/bootstrap.min.js"></script>
        <script src="js/ebctohex.js"></script>
        <script src="js/form2js.js"></script>
        <script type="text/javascript">
		
            $("document").ready(function() {


                $.getJSON('taplist.json', function(data) {
                	populate_form(data);
                 }).done(function() {
	                 start_form_events();
                 });

				                
				$("#create_json_button").on("click", function() {
		    		var d = new Date();
		    		var curr_day = d.getDate();
		    		var curr_month = d.getMonth();
		    		var curr_year = d.getFullYear();
					
					$("input[name=last_updated]").val(('0'+d.getDate()).slice(-2)+'/'+('0'+(d.getMonth()+1)).slice(-2)+'/'+d.getFullYear()+' '+('0'+d.getHours()).slice(-2)+':'+('0'+d.getMinutes()).slice(-2)+'.'+('0'+d.getSeconds()).slice(-2));
					generate_json("#json_output");
				});
        	});

            function populate_form(json_data) {
                $.each(json_data.taps, function(i) {
					
					var tap_name = (this.name == undefined) ? "" : this.name;
					if (!this.beer) {
						var tapped = false;
						var beer_name = "";
						var beer_style = "";
						var beer_abv = "";
						var beer_ibu = "";
						var beer_ebc = "";
					} else {
						var tapped = true;
						var beer_name = (this.beer.name == undefined) ? "" : this.beer.name;
						var beer_style = (this.beer.style == undefined) ? "" : this.beer.style;
						var beer_abv = (this.beer.abv == undefined) ? "" : this.beer.abv;
						var beer_ibu = (this.beer.ibu == undefined) ? "" : this.beer.ibu;
						var beer_ebc = (this.beer.ebc == undefined) ? "" : this.beer.ebc;
					}
                    tap_form = '<div class="col-sm-4"><div class="form-group"><label for="tap'+i+'_label">Tap label</label><input type="text" class="form-control" id="tap'+i+'_label" name="taps['+i+'].name" placeholder="Tap label" value="' + tap_name + '"></div><hr><div class="checkbox"><label><input type="checkbox" id="is_tapped'+i+'" name="taps['+i+'].is_tapped"';
					if (tapped) { tap_form = tap_form + "checked"; }
					tap_form = tap_form + '>Tapped</label></div><hr><div class="form-group"><label for="tap'+i+'_beer_name">Beer name</label><input type="text" class="form-control" id="tap'+i+'_beer_name" name="taps['+i+'].beer.name" placeholder="Beer name" value="' + beer_name + '"></div><div class="form-group"><label for="tap'+i+'_beer_style">Beer style</label><input type="text" class="form-control" id="tap'+i+'_beer_style" name="taps['+i+'].beer.style" placeholder="Beer style" value="' + beer_style + '"></div><div class="row"><div class="col-sm-6"><div class="form-group"><label for="tap'+i+'_beer_abv">Beer ABV</label><div class="input-group"><input type="number" class="form-control" id="tap'+i+'_beer_abv" name="taps['+i+'].beer.abv" placeholder="Beer ABV" value="' + beer_abv + '"><div class="input-group-addon">%</div></div></div></div><div class="col-sm-6"><div class="form-group"><label for="tap'+i+'_beer_ibu">Beer IBU</label><div class="input-group"><input type="number" class="form-control" id="tap'+i+'_beer_ibu" name="taps['+i+'].beer.ibu" placeholder="Beer IBU" value="' + beer_ibu + '"><div class="input-group-addon">IBU</div></div></div></div></div><div class="row"><div class="col-sm-6"><div class="form-group"><label for="tap'+i+'_beer_ebc">Beer colour (EBC)</label><div class="input-group"><input type="number" class="form-control ebc" id="tap'+i+'_beer_ebc" name="taps['+i+'].beer.ebc" placeholder="Beer colour (EBC)" value="' + beer_ebc + '"><div class="input-group-addon">EBC</div></div></div></div><div class="col-sm-6"><div class="form-control colour_indicator" id="tap'+i+'_beer_colour"></div></div></div>';

                    $("#tap_row").append(tap_form);
					$("#tap_row").append('<hr class="visible-xs-block mobile-separator">');
                    $("#tap"+i+"_beer_colour").css("background-color",get_hex_from_ebc(beer_ebc));
					if (!tapped) { clear_tap(i); }
                });
            }

            function update_beer_colour(tap_index) {
                $("#tap"+tap_index+"_beer_colour").css("background-color",get_hex_from_ebc($("#tap"+tap_index+"_beer_ebc").val()));
            }
			
			function generate_json(output_id) {
				$("input[name*='is_tapped']").prop('disabled', true);
				var formData = form2js('tap_admin', '.', true,
				function(node) {
					if (node.id && node.id.match(/callbackTest/)) {
						return { name: node.id, value: node.innerHTML };
					}
				});

				$(output_id).html(JSON.stringify(formData, null, '\t'));
				
				$("input[name*='is_tapped']").prop('disabled', false);
			}
			
	   	 function clear_tap(tap_index) {
	   		 $("input[name*='"+tap_index+"']").slice(2).each(function() {
	   			 $(this).val("");
	   			 $(this).prop("disabled", true);
	   			 update_beer_colour(tap_index);
	   		 });
	   	 }
	 
	   	 function start_form_events() {
	            $("input.ebc").on("change", function() {
	                var index = this.id.replace(/\D/g,'');
	                update_beer_colour(index);
	            });
		 
	   		 $("input[name*='is_tapped']").on("change", function() {
	   			 var tap_index = this.id.replace(/\D/g,'');
	   			 if ($(this).is(':checked')) {
	   				 $("input[name*='"+tap_index+"']").prop("disabled", false);
	   			 } else {
	   				 clear_tap(tap_index);
	   			 }
	   		 });
		 
	   	 }
        </script>
    </body>
</html>
